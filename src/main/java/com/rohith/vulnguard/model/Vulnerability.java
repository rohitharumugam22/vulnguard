package com.rohith.vulnguard.model;

import com.rohith.vulnguard.model.enums.Severity;
import jakarta.persistence.*;

import java.time.LocalDateTime;

@Entity
@Table(name = "vulnerabilities")
public class Vulnerability {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false, length = 30)
    private String cveId;

    @Column(nullable = false, length = 200)
    private String title;

    @Column(length = 1000)
    private String description;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false, length = 20)
    private Severity severity;

    @Column(nullable = false)
    private double cvssScore;

    @Column(nullable = false)
    private int ageInDays;

    @Column(nullable = false)
    private double riskScore;

    @Column(nullable = false)
    private boolean remediated = false;

    @Column(updatable = false)
    private LocalDateTime discoveredAt;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "asset_id", nullable = false)
    private Asset asset;

    @PrePersist
    protected void onCreate() {
        this.discoveredAt = LocalDateTime.now();
    }

    // ── Constructors ──────────────────────────────────────────────────
    public Vulnerability() {}

    // ── Getters ───────────────────────────────────────────────────────
    public Long getId()                    { return id; }
    public String getCveId()               { return cveId; }
    public String getTitle()               { return title; }
    public String getDescription()         { return description; }
    public Severity getSeverity()          { return severity; }
    public double getCvssScore()           { return cvssScore; }
    public int getAgeInDays()              { return ageInDays; }
    public double getRiskScore()           { return riskScore; }
    public boolean isRemediated()          { return remediated; }
    public LocalDateTime getDiscoveredAt() { return discoveredAt; }
    public Asset getAsset()                { return asset; }

    // ── Setters ───────────────────────────────────────────────────────
    public void setId(Long id)                         { this.id = id; }
    public void setCveId(String cveId)                 { this.cveId = cveId; }
    public void setTitle(String title)                 { this.title = title; }
    public void setDescription(String description)     { this.description = description; }
    public void setSeverity(Severity severity)         { this.severity = severity; }
    public void setCvssScore(double cvssScore)         { this.cvssScore = cvssScore; }
    public void setAgeInDays(int ageInDays)            { this.ageInDays = ageInDays; }
    public void setRiskScore(double riskScore)         { this.riskScore = riskScore; }
    public void setRemediated(boolean remediated)      { this.remediated = remediated; }
    public void setDiscoveredAt(LocalDateTime d)       { this.discoveredAt = d; }
    public void setAsset(Asset asset)                  { this.asset = asset; }

    // ── Builder ───────────────────────────────────────────────────────
    public static Builder builder() {
        return new Builder();
    }

    public static class Builder {
        private String cveId;
        private String title;
        private String description;
        private Severity severity;
        private double cvssScore;
        private int ageInDays;
        private double riskScore;
        private boolean remediated = false;
        private Asset asset;

        public Builder cveId(String cveId)             { this.cveId = cveId; return this; }
        public Builder title(String title)             { this.title = title; return this; }
        public Builder description(String description) { this.description = description; return this; }
        public Builder severity(Severity severity)     { this.severity = severity; return this; }
        public Builder cvssScore(double cvssScore)     { this.cvssScore = cvssScore; return this; }
        public Builder ageInDays(int ageInDays)        { this.ageInDays = ageInDays; return this; }
        public Builder riskScore(double riskScore)     { this.riskScore = riskScore; return this; }
        public Builder remediated(boolean remediated)  { this.remediated = remediated; return this; }
        public Builder asset(Asset asset)              { this.asset = asset; return this; }

        public Vulnerability build() {
            Vulnerability v = new Vulnerability();
            v.cveId = this.cveId;
            v.title = this.title;
            v.description = this.description;
            v.severity = this.severity;
            v.cvssScore = this.cvssScore;
            v.ageInDays = this.ageInDays;
            v.riskScore = this.riskScore;
            v.remediated = this.remediated;
            v.asset = this.asset;
            return v;
        }
    }
}
